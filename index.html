<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>EDUCATION SERVICES UNIT DATABASE - 4TH DISTRICT</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
/* (keep your existing styles or paste from original) */
body{font-family:Arial,sans-serif;margin:0;padding:20px;background:#f5f7fb;}
h1,h2{margin-bottom:12px;}
.card{background:#fff;border-radius:10px;padding:16px;margin-bottom:20px;box-shadow:0 4px 12px rgba(0,0,0,0.05);}
form{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
label{font-size:12px;color:#444}
input,select{padding:8px;border-radius:6px;border:1px solid #d6dbe6;}
.full{grid-column:1/-1}
button{padding:8px 12px;border:none;border-radius:6px;cursor:pointer}
button.primary{background:#2b6ef6;color:#fff}
button.ghost{background:#fff;border:1px solid #d6dbe6;color:#000}
table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{padding:8px;border-bottom:1px solid #eef2f8;text-align:left}
tr.duplicate{background:#fff8e6}
.program-list{margin:0;padding-left:16px;list-style:disc;}
.searchbar{display:flex;gap:8px;margin-top:12px;}
#importModal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.4);z-index:9999;justify-content:center;align-items:center;}
#importModalContent{background:#fff;padding:20px 30px;border-radius:10px;text-align:center;min-width:300px;}
#progressBarContainer{width:100%;background:#eee;border-radius:6px;margin-top:10px;}
#importProgressBar{width:0%;height:20px;background:#2b6ef6;border-radius:6px;text-align:center;color:#fff;}
#importProgressText{margin-top:4px;font-size:12px;}
#dupWarnModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);z-index:10000;justify-content:center;align-items:center;}
#dupWarnContent{background:#fff;padding:20px;border-radius:10px;min-width:360px;max-width:90%;box-shadow:0 10px 30px rgba(0,0,0,0.2);}
.dup-list{max-height:200px;overflow:auto;border:1px solid #eee;padding:8px;border-radius:6px;margin:8px 0;}
.small{font-size:13px;color:#444}
.dup-reason{background:#fff3cd;padding:8px;border-radius:6px;margin-bottom:8px}
.tabbar{margin-bottom:20px;display:flex;gap:8px}
kbd{background:#f1f5f9;padding:2px 6px;border-radius:4px;font-size:12px}
</style>
</head>
<body>
<h1>EDUCATION SERVICES UNIT DATABASE - 4TH DISTRICT</h1>

<div class="tabbar">
  <button id="tabBeneficiaries" class="primary">Beneficiaries</button>
  <button id="tabReports" class="ghost">Reports</button>
</div>

<div id="beneficiariesTab">
  <div class="card">
    <h2>Add / Edit Beneficiary</h2>
    <form id="beneficiaryForm">
      <div><label>Application Date</label><input id="applicationDate" type="date" required /></div>
      <div><label>First Name</label><input id="firstName" type="text" required /></div>
      <div><label>Middle Name</label><input id="middleName" type="text" /></div>
      <div><label>Last Name</label><input id="lastName" type="text" required /></div>
      <div><label>Suffix</label>
        <select id="suffix">
          <option>N/A</option><option>Jr.</option><option>Sr.</option><option>I</option><option>II</option><option>III</option><option>IV</option>
        </select>
      </div>
      <div><label>Relationship</label>
        <select id="relationship">
          <option>Self</option><option>Mother</option><option>Father</option><option>Sister</option><option>Brother</option>
          <option>Grandmother</option><option>Grandfather</option><option>Other</option>
        </select>
      </div>
      <div><label>Name of Beneficiary/Client</label><input id="beneficiaryName" type="text" placeholder="Auto-filled if Self" /></div>
      <div><label>School</label><input id="school" type="text" /></div>
      <div><label>Grade/Year Level</label><input id="gradeLevel" type="text" /></div>
      <div><label>School Year</label>
        <select id="schoolYear">
          <option>2022</option><option>2023</option><option>2024</option><option>2025</option>
        </select>
      </div>
      <div><label>Birth Date</label><input id="birthDate" type="date" /></div>
      <div><label>Civil Status</label>
        <select id="civilStatus">
          <option>Single</option><option>Married</option><option>Widowed</option><option>Separated</option><option>Divorced</option>
        </select>
      </div>
      <div><label>Gender</label>
        <select id="gender">
          <option>Male</option><option>Female</option><option>Other</option>
        </select>
      </div>
      <div><label>Family Member</label><input id="familyMember" type="text" /></div>
      <div><label>CP Number</label><input id="cpNumber" type="tel" /></div>
      <div>
  <label>Municipality</label>
  <select id="municipality" required>
    <option value="">-- Select Municipality --</option>
    <option value="CITY OF SANTIAGO">CITY OF SANTIAGO</option>
    <option value="CORDON">CORDON</option>
    <option value="SAN AGUSTIN">SAN AGUSTIN</option>
    <option value="JONES">JONES</option>
    <option value="DINAPIGUE">DINAPIGUE</option>
  </select>
</div>

<div>
  <label>Barangay</label>
  <select id="barangay" required>
    <option value="">-- Select Barangay --</option>
  </select>
</div>

      <div><label>Province</label><input id="province" type="text" value="ISABELA" readonly /></div>
      <div><label>Programs (comma separated)</label><input id="programs" type="text" placeholder="Program1, Program2" /></div>
      <div><label>Amount</label><input id="amount" type="text" placeholder="e.g., 500, 1000, 2500" /></div>
      <div><label>Status</label>
        <select id="status"><option>Paid</option><option>Unpaid</option></select>
      </div>
      <div><label><input type="checkbox" id="forceEditNames"/> Force Edit Name, Birthdate, Barangay, CP, Gender, Civil Status</label></div>
      <div class="full actions">
        <button type="button" class="primary" id="saveBeneficiaryBtn">Save Beneficiary</button>
        <button type="button" class="ghost" id="clearForm">Clear</button>
        <button type="button" class="ghost" id="exportXlsxBtn">Export XLSX</button>
        <button type="button" class="ghost" id="importXlsxBtn">Import XLSX</button>
        <button type="button" class="ghost" id="deleteAllBtn" style="background:#ff4d4d;color:#fff;">Delete All Records</button>
        <button type="button" class="ghost" id="detectDuplicatesBtn" style="background:#ffcc00;color:#000;">Detect Duplicates</button>
      </div>
    </form>
  </div>

<div id="paginationControls" style="margin-top:10px; display:flex; justify-content:flex-end; gap:6px; align-items:center;">
  <button id="prevPageBtn" class="ghost">Previous</button>
  <span id="pageInfo">Page 1</span>
  <button id="nextPageBtn" class="ghost">Next</button>
</div>

  <div class="card">
    <h2>Beneficiaries</h2>
    <div class="searchbar">
      <input id="globalSearch" placeholder="Search..." style="flex:1;padding:8px;border-radius:6px;border:1px solid #d6dbe6" />
      <button id="clearSearch" class="ghost">Clear</button>
      <select id="filterSchoolYear">
        <option value="">All School Years</option>
        <option>2022</option><option>2023</option><option>2024</option><option>2025</option>
      </select>
      <select id="filterDuplicate">
        <option value="">All Records</option>
        <option value="yes">Duplicates Only</option>
        <option value="no">Non-Duplicates</option>
      </select>
    </div>
<select id="filterMunicipality">
  <option value="">All Municipalities</option>
  <option>CITY OF SANTIAGO</option>
  <option>CORDON</option>
  <option>SAN AGUSTIN</option>
  <option>JONES</option>
  <option>DINAPIGUE</option>
</select>

<select id="filterBarangay">
  <option value="">All Barangays</option>
</select>

    <table id="beneficiariesTable">
      <thead>
        <tr>
          <th>ID</th><th>Application Date</th><th>Name</th><th>Relationship</th><th>Beneficiary</th>
          <th style="display:none;">School</th><th>Grade/Year Level</th><th>School Year</th><th>Birth</th>
          <th>Civil Status</th><th>Gender</th><th>Family</th><th>CP</th><th>Barangay</th>
          <th>Municipality</th><th style="display:none;">Province</th><th>Programs</th><th>Amount</th>
          <th>Status</th><th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <input id="fileInput" type="file" accept=".xlsx,.xls" style="display:none" />

  <div id="importModal">
    <div id="importModalContent">
      <h3>Importing...</h3>
      <div id="progressBarContainer">
        <div id="importProgressBar">0%</div>
      </div>
      <div id="importProgressText">0%</div>
      <button id="importCancelBtn" style="margin-top:12px;">Cancel Import</button>
    </div>
  </div>

  <div id="dupWarnModal">
    <div id="dupWarnContent">
      <h3>Duplicate Found</h3>
      <div class="dup-reason small" id="dupReasonText"></div>
      <div class="small">Matching existing record(s):</div>
      <div class="dup-list" id="dupList"></div>
      <div style="margin-top:12px;text-align:right">
        <button id="cancelSaveBtn" class="ghost">Cancel</button>
        <button id="confirmSaveBtn" class="primary">Save Anyway</button>
      </div>
    </div>
  </div>
</div>

<div id="reportsTab" style="display:none;">
  <div class="card">
    <h2>Program Report per Barangay</h2>
    <div style="margin-bottom:10px">
      <div style="margin-bottom:10px">
  <label>Filter School Year: </label>
  <select id="reportFilterSchoolYear">
    <option value="">All</option>
    <option>2022</option><option>2023</option><option>2024</option><option>2025</option>
  </select>

  <label style="margin-left:10px">Municipality: </label>
  <select id="reportFilterMunicipality">
    <option value="">All</option>
    <option>CITY OF SANTIAGO</option>
    <option>CORDON</option>
    <option>SAN AGUSTIN</option>
    <option>JONES</option>
    <option>DINAPIGUE</option>
  </select>

  <label style="margin-left:10px">Barangay: </label>
  <select id="reportFilterBarangay">
    <option value="">All</option>
  </select>

  <button id="refreshReportBtn" class="ghost" style="margin-left:8px">Refresh</button>
</div>

    <table id="reportTable">
      <thead>
        <tr>
          <th>Barangay</th>
          <th>Program</th>
          <th>Total Beneficiaries</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
/* ---------- CONFIG ---------- */
const SHEET_API_URL = "https://script.google.com/macros/s/AKfycbxByB5gV_lPL-Tjgc7txQGWjJhOa9hUksXOuhj09WE2oVlvMv2E2MLnuiq-7pdVD4E/exec";

/* ---------- STATE ---------- */
let currentPage = 1;
const recordsPerPage = 50;
let allRecords = [];
let filteredRecords = [];
let editingId = null;
let cancelImport = false;

/* ---------- Utilities ---------- */
function todayISO(){
  const d=new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}
function generate5DigitID(){ return String(Math.floor(10000+Math.random()*90000)); }
function deepCopy(o){ return JSON.parse(JSON.stringify(o)); }

/* ---------- Load / Save ---------- */
async function fetchAll(){
  try{
    const res = await fetch(SHEET_API_URL);
    const data = await res.json();
    // Ensure programs is array
    allRecords = data.map(r=>{
      if(typeof r.programs === "string" && r.programs.indexOf("|")!==-1){
        r.programs = r.programs.split("|").map(x=>x.trim()).filter(Boolean);
      } else if(!Array.isArray(r.programs)){
        r.programs = r.programs ? [String(r.programs)] : [];
      }
      // Normalize duplicate flag
      r.duplicate = (r.duplicate === true || String(r.duplicate).toLowerCase() === "true") ? true : false;
      return r;
    });
  }catch(err){
    console.error("Fetch failed",err);
    allRecords = [];
  }
}

async function postAction(action, payload){
  const body = Object.assign({action}, payload || {});
  try{
    const res = await fetch(SHEET_API_URL, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(body)
    });
    return await res.json();
  }catch(err){
    console.error("postAction error",err);
    return {error:err.message};
  }
}

/* ---------- Render Table & Pagination ---------- */
async function renderTable(filter=''){
  await fetchAll();
  const tbody = document.querySelector('#beneficiariesTable tbody');
  tbody.innerHTML = '';

  const q = (filter || '').toLowerCase();
  const schoolFilter = document.getElementById('filterSchoolYear').value;
  const dupFilter = document.getElementById('filterDuplicate').value;
  const municipalityFilter = document.getElementById('filterMunicipality').value;
  const barangayFilter = document.getElementById('filterBarangay').value;

  filteredRecords = allRecords.filter(b=>{
    const searchPool = [
      b.firstName,b.middleName,b.lastName,b.beneficiaryName,b.familyMember,b.cpNumber,
      b.barangay,b.municipality,b.status,b.civilStatus,b.gender,b.schoolYear,b.amount,
      ...(b.programs||[])
    ].join(' ').toLowerCase();

    if(q && !searchPool.includes(q)) return false;
    if(schoolFilter && b.schoolYear !== schoolFilter) return false;
    if(dupFilter==='yes' && !b.duplicate) return false;
    if(dupFilter==='no' && b.duplicate) return false;
    if(municipalityFilter && b.municipality !== municipalityFilter) return false;
    if(barangayFilter && b.barangay !== barangayFilter) return false;
    return true;
  });

  // sort by barangay, last, first, middle
  filteredRecords.sort((a,b)=>{
    const br = (a.barangay||'').toLowerCase().localeCompare((b.barangay||'').toLowerCase());
    if(br !== 0) return br;
    const la = (a.lastName||'').toLowerCase().localeCompare((b.lastName||'').toLowerCase());
    if(la !== 0) return la;
    const fa = (a.firstName||'').toLowerCase().localeCompare((b.firstName||'').toLowerCase());
    if(fa !== 0) return fa;
    return (a.middleName||'').toLowerCase().localeCompare((b.middleName||'').toLowerCase());
  });

  const totalPages = Math.max(1, Math.ceil(filteredRecords.length / recordsPerPage));
  if(currentPage > totalPages) currentPage = totalPages;
  const start = (currentPage-1)*recordsPerPage;
  const rows = filteredRecords.slice(start, start + recordsPerPage);

  for(const b of rows){
    let birthFormatted='';
    if(b.birthDate){
      const dt = new Date(b.birthDate);
      if(!isNaN(dt)) birthFormatted = `${String(dt.getMonth()+1).padStart(2,'0')}/${String(dt.getDate()).padStart(2,'0')}/${dt.getFullYear()}`;
      else birthFormatted = b.birthDate;
    }
    const tr = document.createElement('tr');
    if(b.duplicate) tr.classList.add('duplicate');
    tr.innerHTML = `
      <td>${b.id||''}</td>
      <td>${b.applicationDate||''}</td>
      <td>${[b.firstName,b.middleName,b.lastName,(b.suffix && b.suffix!=='N/A')?b.suffix:''].join(' ').replace(/\s+/g,' ').trim()}</td>
      <td>${b.relationship||''}</td>
      <td>${b.beneficiaryName||''}</td>
      <td style="display:none;">${b.school||''}</td>
      <td>${b.gradeLevel||''}</td>
      <td>${b.schoolYear||''}</td>
      <td>${birthFormatted}</td>
      <td>${b.civilStatus||''}</td>
      <td>${b.gender||''}</td>
      <td>${b.familyMember||''}</td>
      <td>${b.cpNumber||''}</td>
      <td>${b.barangay||''}</td>
      <td>${b.municipality||''}</td>
      <td style="display:none;">${b.province||''}</td>
      <td><ul class="program-list">${(b.programs||[]).map(p=>`<li>${p}</li>`).join('')}</ul></td>
      <td>${b.amount||''}</td>
      <td>${b.status||''}</td>
      <td>
        <button onclick="startEdit('${b.id}')">Edit</button>
        <button onclick="deleteEntry('${b.id}')">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  }

  document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
}

/* ---------- Edit / Add / Delete ---------- */
function startEdit(id){
  const rec = allRecords.find(r => String(r.id) === String(id));
  if(!rec) return alert('Record not found for editing.');
  editingId = rec.id;
  // populate fields
  const fields = ['applicationDate','firstName','middleName','lastName','suffix','relationship','beneficiaryName','school','gradeLevel','schoolYear','birthDate','civilStatus','gender','familyMember','cpNumber','barangay','municipality','province','programs','amount','status'];
  fields.forEach(k=>{
    const el = document.getElementById(k);
    if(!el) return;
    if(k==='programs') el.value = (rec.programs||[]).join(', ');
    else el.value = rec[k] !== undefined && rec[k] !== null ? rec[k] : '';
  });

  // lock protected fields until forceEditNames is checked
  ['firstName','middleName','lastName','birthDate','barangay','cpNumber','gender','civilStatus'].forEach(f=>{
    const el = document.getElementById(f);
    if(!el) return;
    el.readOnly = true;
    if(el.tagName.toLowerCase() === 'select') el.disabled = true;
  });

  const fe = document.getElementById('forceEditNames');
  fe.checked = false;
  fe.onchange = ()=> {
    const editable = fe.checked;
    ['firstName','middleName','lastName','birthDate','barangay','cpNumber','gender','civilStatus'].forEach(f=>{
      const el = document.getElementById(f);
      if(!el) return;
      if(el.tagName.toLowerCase() === 'select') el.disabled = !editable;
      else el.readOnly = !editable;
    });
  };
}

async function saveBeneficiaryRecord(forceSave=false){
  // gather record
  const rec = {
    id: editingId ? editingId : generate5DigitID(),
    applicationDate: document.getElementById('applicationDate').value || todayISO(),
    firstName: document.getElementById('firstName').value.trim(),
    middleName: document.getElementById('middleName').value.trim(),
    lastName: document.getElementById('lastName').value.trim(),
    suffix: document.getElementById('suffix').value,
    relationship: document.getElementById('relationship').value,
    beneficiaryName: document.getElementById('beneficiaryName').value.trim(),
    school: document.getElementById('school').value.trim(),
    gradeLevel: document.getElementById('gradeLevel').value.trim(),
    schoolYear: document.getElementById('schoolYear').value,
    birthDate: document.getElementById('birthDate').value,
    civilStatus: document.getElementById('civilStatus').value,
    gender: document.getElementById('gender').value,
    familyMember: document.getElementById('familyMember').value.trim(),
    cpNumber: document.getElementById('cpNumber').value.trim(),
    barangay: document.getElementById('barangay').value,
    municipality: document.getElementById('municipality').value,
    province: document.getElementById('province').value,
    programs: (document.getElementById('programs').value || '').split(',').map(p=>p.trim()).filter(Boolean),
    amount: document.getElementById('amount').value.trim(),
    status: document.getElementById('status').value,
    duplicate: false
  };

  // duplicate detection locally (name, birth, cp)
  if(!forceSave){
    const matches = allRecords.filter(e => {
      if(editingId && String(e.id) === String(editingId)) return false;
      const nameE = `${(e.firstName||'')} ${(e.middleName||'')} ${(e.lastName||'')}`.replace(/\s+/g,' ').trim().toLowerCase();
      const nameR = `${rec.firstName} ${rec.middleName} ${rec.lastName}`.replace(/\s+/g,' ').trim().toLowerCase();
      const nameMatch = nameR && nameE === nameR;
      const birthMatch = rec.birthDate && e.birthDate === rec.birthDate;
      const cpMatch = rec.cpNumber && e.cpNumber && e.cpNumber.trim() === rec.cpNumber.trim();
      return nameMatch || birthMatch || cpMatch;
    });

    if(matches.length > 0){
      // show dup modal
      const dupList = document.getElementById('dupList');
      dupList.innerHTML = '';
      const reasons = new Set();
      matches.forEach(m => {
        const reasonParts=[];
        const nameE = `${(m.firstName||'')} ${(m.middleName||'')} ${(m.lastName||'')}`.replace(/\s+/g,' ').trim().toLowerCase();
        const nameR = `${rec.firstName} ${rec.middleName} ${rec.lastName}`.replace(/\s+/g,' ').trim().toLowerCase();
        if(nameE === nameR) reasonParts.push('Name');
        if(m.birthDate && rec.birthDate && m.birthDate === rec.birthDate) reasonParts.push('Birthdate');
        if(m.cpNumber && rec.cpNumber && m.cpNumber.trim() === rec.cpNumber.trim()) reasonParts.push('CP Number');
        reasonParts.forEach(r=>reasons.add(r));
        const div = document.createElement('div');
        div.className = 'small';
        div.innerHTML = `<strong>ID:</strong> ${m.id} â€” ${m.firstName} ${m.middleName} ${m.lastName} <br> <strong>Birth:</strong> ${m.birthDate||'(empty)'} &nbsp; <strong>CP:</strong> ${m.cpNumber||'(empty)'} <br> <strong>Barangay:</strong> ${m.barangay||'(empty)'} <hr style="margin:8px 0">`;
        dupList.appendChild(div);
      });
      document.getElementById('dupReasonText').textContent = `Detected match by: ${Array.from(reasons).join(', ')}`;
      document.getElementById('dupWarnModal').style.display = 'flex';
      document.getElementById('cancelSaveBtn').onclick = ()=>{ document.getElementById('dupWarnModal').style.display='none'; };
      document.getElementById('confirmSaveBtn').onclick = async ()=>{ document.getElementById('dupWarnModal').style.display='none'; await saveBeneficiaryRecord(true); };
      return;
    }
  }

  // send to server
  if(editingId){
    // update
    const resp = await postAction('update',{record:rec});
    editingId = null;
  } else {
    // add
    const resp = await postAction('add',{record:rec});
  }

  document.getElementById('beneficiaryForm').reset();
  document.getElementById('beneficiaryName').readOnly=false;
  await renderTable();
}

/* ---------- Delete ---------- */
async function deleteEntry(id){
  if(!confirm('Delete this record?')) return;
  await postAction('delete',{id});
  await renderTable();
}

/* ---------- Delete All ---------- */
document.getElementById('deleteAllBtn').onclick = async ()=>{
  if(!confirm("Are you sure you want to delete ALL records?")) return;
  await postAction('deleteAll',{});
  await renderTable();
  alert('All records deleted.');
};

/* ---------- Export XLSX ---------- */
document.getElementById('exportXlsxBtn').onclick = async ()=>{
  await fetchAll();
  const ws = XLSX.utils.json_to_sheet(allRecords.map(r=>{
    // flatten programs as pipe-separated
    return Object.assign({}, r, {programs: Array.isArray(r.programs) ? r.programs.join(" | ") : r.programs});
  }));
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Beneficiaries');
  XLSX.writeFile(wb, 'beneficiaries.xlsx');
};

/* ---------- Import XLSX (bulkAdd) ---------- */
document.getElementById('importXlsxBtn').onclick = ()=>document.getElementById('fileInput').click();
document.getElementById('importCancelBtn').onclick = ()=>{ cancelImport = true; };
document.getElementById('fileInput').onchange = async e=>{
  const file = e.target.files[0]; if(!file) return;
  cancelImport = false;
  const modal = document.getElementById('importModal');
  const progressBar = document.getElementById('importProgressBar');
  const progressText = document.getElementById('importProgressText');
  modal.style.display = 'flex'; progressBar.style.width='0%'; progressBar.textContent='0%'; progressText.textContent='0%';

  const reader = new FileReader();
  reader.onload = async evt=>{
    const data = new Uint8Array(evt.target.result);
    const wb = XLSX.read(data, {type:'array'});
    const ws = wb.Sheets[wb.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(ws, {defval:''});
    // map to records
    const toAdd = json.map(r => {
      const rec = {
        id: generate5DigitID(),
        applicationDate: r.ApplicationDate || r.Application || todayISO(),
        firstName: r.FirstName || r.Firstname || '',
        middleName: r.MiddleName || '',
        lastName: r.LastName || r.Lastname || '',
        suffix: r.Suffix || 'N/A',
        relationship: r.Relationship || 'Self',
        beneficiaryName: r.BeneficiaryName || `${r.FirstName||''} ${r.MiddleName||''} ${r.LastName||''}`.trim(),
        school: r.School || '',
        gradeLevel: r.GradeLevel || '',
        schoolYear: r.SchoolYear || '2022',
        birthDate: r.Birth || r.BirthDate || '',
        civilStatus: r.CivilStatus || 'Single',
        gender: r.Gender || 'Male',
        familyMember: r.Family || '',
        cpNumber: (r.CP||'').toString().trim(),
        barangay: r.Barangay || '',
        municipality: r.Municipality || '',
        province: r.Province || 'Isabela',
        programs: r.Programs ? String(r.Programs).split('|').map(p=>p.trim()).filter(Boolean) : [],
        amount: r.Amount || '',
        status: r.Status || 'Unpaid',
        duplicate: false
      };
      return rec;
    });

    // send in chunks with bulkAdd
    const chunkSize = 200;
    for(let i=0;i<toAdd.length;i+=chunkSize){
      if(cancelImport) break;
      const chunk = toAdd.slice(i, i+chunkSize);
      await postAction('bulkAdd', {records: chunk});
      const percent = Math.round((Math.min(i+chunkSize,toAdd.length)/toAdd.length)*100);
      progressBar.style.width = percent + '%';
      progressBar.textContent = percent + '%';
      progressText.textContent = `Imported ${Math.min(i+chunkSize,toAdd.length)}/${toAdd.length} rows.`;
      await new Promise(r=>setTimeout(r,100)); // small pause
    }

    modal.style.display='none';
    if(!cancelImport) alert(`Import completed. Total rows: ${toAdd.length}`);
    else alert('Import cancelled.');
    await renderTable();
  };
  reader.readAsArrayBuffer(file);
};

/* ---------- Detect Duplicates (and optionally push flag to sheet) ---------- */
document.getElementById('detectDuplicatesBtn').onclick = async ()=>{
  await fetchAll();
  const keyMap = {};
  let duplicatesFound = 0;
  // mark duplicates locally
  for(const b of allRecords){
    const fullName = `${b.firstName||''} ${b.middleName||''} ${b.lastName||''}`.toLowerCase().replace(/\s+/g,' ').trim();
    const birth = (b.birthDate||'').trim();
    const cp = (b.cpNumber||'').trim();
    const barangay = (b.barangay||'').toLowerCase().trim();
    const key = `${fullName}|${birth}|${cp}|${barangay}`;
    if(keyMap[key]) {
      b.duplicate = true;
      duplicatesFound++;
    } else {
      keyMap[key] = true;
      b.duplicate = false;
    }
  }

  // push updates for duplicate flags to sheet (batch updates could be optimized, we'll update each changed row)
  for(const b of allRecords){
    await postAction('update',{record:b});
  }

  await renderTable();
  alert(`Duplicate Check Completed.\nFound ${duplicatesFound} duplicate records.`);
};

/* ---------- Search, pagination, misc ---------- */
document.getElementById('globalSearch').oninput = e => { currentPage = 1; renderTable(e.target.value); };
document.getElementById('clearSearch').onclick = ()=>{ document.getElementById('globalSearch').value=''; renderTable(); };
document.getElementById('filterSchoolYear').onchange = ()=>renderTable();
document.getElementById('filterDuplicate').onchange = ()=>renderTable();
document.getElementById('filterMunicipality').onchange = ()=>renderTable();
document.getElementById('filterBarangay').onchange = ()=>renderTable();

document.getElementById('prevPageBtn').onclick = ()=>{ if(currentPage>1){ currentPage--; renderTable(); } };
document.getElementById('nextPageBtn').onclick = ()=>{ const total = Math.max(1,Math.ceil(filteredRecords.length/recordsPerPage)); if(currentPage<total){ currentPage++; renderTable(); } };

document.getElementById('saveBeneficiaryBtn').onclick = async ()=>{ await saveBeneficiaryRecord(false); };
document.getElementById('clearForm').onclick = ()=>{ document.getElementById('beneficiaryForm').reset(); editingId = null; document.getElementById('forceEditNames').checked=false; document.getElementById('beneficiaryName').readOnly=false; };

document.getElementById("tabBeneficiaries").onclick = ()=>{ document.getElementById("beneficiariesTab").style.display="block"; document.getElementById("reportsTab").style.display="none"; document.getElementById("tabBeneficiaries").className="primary"; document.getElementById("tabReports").className="ghost"; renderTable(); };
document.getElementById("tabReports").onclick = async ()=>{ document.getElementById("beneficiariesTab").style.display="none"; document.getElementById("reportsTab").style.display="block"; document.getElementById("tabReports").className="primary"; document.getElementById("tabBeneficiaries").className="ghost"; await generateReportTable(); };

document.getElementById('refreshReportBtn').onclick = generateReportTable;
document.getElementById('reportFilterSchoolYear').onchange = generateReportTable;
document.getElementById('reportFilterMunicipality').onchange = generateReportTable;
document.getElementById('reportFilterBarangay').onchange = generateReportTable;

/* ---------- Report generation ---------- */
async function generateReportTable(){
  const tbody = document.querySelector("#reportTable tbody");
  tbody.innerHTML = "";
  await fetchAll();

  const schoolFilter = document.getElementById('reportFilterSchoolYear').value;
  const municipalityFilter = document.getElementById('reportFilterMunicipality').value;
  const barangayFilter = document.getElementById('reportFilterBarangay').value;

  const reportData = {};
  allRecords.forEach(rec=>{
    if(schoolFilter && rec.schoolYear !== schoolFilter) return;
    if(municipalityFilter && rec.municipality !== municipalityFilter) return;
    if(barangayFilter && rec.barangay !== barangayFilter) return;
    const barr = (rec.barangay&&rec.barangay.trim())?rec.barangay.trim():'Unknown';
    const programs = (rec.programs && rec.programs.length) ? rec.programs : ['(No Program)'];
    if(!reportData[barr]) reportData[barr]={};
    programs.forEach(p=>{
      const key = p && p.trim()?p.trim():'(No Program)';
      if(!reportData[barr][key]) reportData[barr][key]=0;
      reportData[barr][key]++;
    });
  });

  const barangays = Object.keys(reportData).sort((a,b)=>a.localeCompare(b));
  for(const bar of barangays){
    const programs = Object.keys(reportData[bar]).sort((a,b)=>a.localeCompare(b));
    for(const prog of programs){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${bar}</td><td>${prog}</td><td>${reportData[bar][prog]}</td>`;
      tbody.appendChild(tr);
    }
  }

  if(tbody.children.length===0){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td colspan="3" style="text-align:center;color:#666;padding:12px">No data available for selected filters.</td>`;
    tbody.appendChild(tr);
  }
}

/* ---------- Init ---------- */
window.addEventListener('DOMContentLoaded', () => {
  renderTable();
});
</script>
</body>
</html>
